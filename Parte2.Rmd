---
title: "Parte 2"
subtitle: "Corregir<br>(GMT)"
author: "Miriam Lerma"
date: "Marzo 2021"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    seal: false
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: true
      
---

```{r xaringan-themer, include=FALSE, warning=FALSE}
library(xaringanthemer)
style_mono_accent(
  base_color = "#2a9d8f",
  header_font_google = google_font("Josefin Sans"),
  text_font_google   = google_font("Josefin Sans"),
  code_font_google   = google_font("Roboto Mono"),
  background_color = "#faf9f9",
  text_color = "#40916c",
  code_inline_background_color = '#83c5be'
)
```

```{r include = FALSE}
#Paquetes
library(xaringanExtra)
library(fontawesome)
```

class: title-slide, inverse, middle, right
<h1>`r fa("clock", fill = "#52b788")` `r fa("clock", fill = "#74c69d")` `r fa("clock", fill = "#95d5b2")` `r fa("clock", fill = "#b7e4c7")` `r fa("clock", fill = "#d8f3dc")` 

### `r rmarkdown::metadata$title`
# `r rmarkdown::metadata$subtitle`

`r rmarkdown::metadata$author`<br>
`r rmarkdown::metadata$date`

<h1>`r fa("clock", fill = "#52b788")` `r fa("clock", fill = "#74c69d")` `r fa("clock", fill = "#95d5b2")` `r fa("clock", fill = "#b7e4c7")` `r fa("clock", fill = "#d8f3dc")` 

---

# Intro

En esta presentación verán como:
- Cargar datos de GPS <br>
- Corregir la hora de acuerdo al GMT

```{r, echo=FALSE,include=FALSE, message=FALSE}
library(emo)
library(here)
library(ggplot2)
```

--

## Ustedes

- Tienes una base de datos con datos de GPS <br>
- Tienen conocimientos básicos de R, si no te recomiendo [empezar por aquí](https://miriamlerma.netlify.app/posts/2021-03-01-introar/) <br>
- Necesitan corregir la hora de sus GPSs
  
---

class:center,middle

<h3>`r fa("download", fill = "#2a9d8f")`

## 1. Importar datos a R

Para esta parte necesitas saber cargar tus datos, si necesitas recordar como hacerlo, te recomiendo [empezar por aquí](https://miriamll.github.io/Curso_tracking/Parte1).

---

### 1.1. Cargar datos

Cargar el paquete tidyverse.
```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
```

Definir tu carpeta.
```{r}
# Ruta relativa
DatosFolder<-here("01Datos")
```

Enlistar tus archivos.
```{r}
Lista_GPS <- list.files(DatosFolder,pattern="*.csv",full.names=TRUE)
```
Importante: tu debes definir si son txt, xlsx o csvs.

---

### 1.2. Leer y unir multiples archivos

Esta función sirve para leer todos los archivos.
```{r, message=FALSE}
Lista_GPS <- lapply(Lista_GPS,read_csv)
```
Si quieres descargar los archivos de prueba [ve aquí](https://github.com/MiriamLL/Curso_tracking/tree/main/01Datos).

Para poder identificar los diferentes GPS, antes de unir todos tus datos deberás agregar un ID.

Eta funcion usa los nombres de los archivos.
```{r}
Nombres_archivos<-list.files(DatosFolder,pattern="*.csv",
                             full.names=FALSE)
IDs<-gsub('.csv','',Nombres_archivos)
```

Aqui agrega una columna a cada elemento de la lista con su respectivo ID.
```{r}
for( i in seq_along(Lista_GPS)){
  Lista_GPS[[i]]$IDs <- IDs[i]
}
```

---

### 1.3. Unir multiples archivos

Esta función te permite unirlos _rbind_ es de row (fila) bind (unir).
```{r}
Todos_GPS <- do.call("rbind",Lista_GPS)
```
Pero **ojo** el numero de columnas y nombres de las columnas debe ser el mismo.

```{r}
Todos_GPS
```


---

class:center,middle

<h1>`r fa("search", fill = "#2a9d8f")`
## 2. Revisar el día y la hora
Para esta parte puedes necesitar algunos básicos de como manipular data frames en R, si necesitas más información [ve aquí](https://miriamll.github.io/Curso_CIAD/Clase3Parte2#1).

---

### 2.1. Identifica tu zona horaria

Es común que los datos se GPS se registren en GMT+0. <br>
Cuando usamos GPS en América Latina, tienes que identificar en que zona horaria te encuentras.

.center[
```{r echo=FALSE, out.height=350}
knitr::include_graphics("https://upload.wikimedia.org/wikipedia/commons/thumb/d/d2/Timezones2008_UTC%2B0.png/1200px-Timezones2008_UTC%2B0.png")
```
]

---

### 2.2. Día Hora

Vamos a revisar nuestros datos de día y hora.  
Primero unimos las columnas de día y hora en los datos de GPS y convertimos al formato POSIXct para que R entienda que son día y hora.

Para unirlos en una columna:
```{r}
Todos_GPS$DiaHora<-paste(Todos_GPS$DateGMT,Todos_GPS$TimeGMT)
```

Para decirle que son día y hora:
```{r}
Todos_GPS$DiaHora<-as.POSIXct(strptime(Todos_GPS$DiaHora, 
                                       "%d/%m/%Y %H:%M:%S"),"GMT")
```

Considera que:  
.pull-left[
- **y** es para **año**   
- **m** es para **mes**  
- **d** es para **día**]  
.pull-right[
- **H** es para **Hora**  
- **M** es para **Minuto**  
- **S** es para **Segundo**  
]

<br>
_Nota que la m para mes es en minusculas y para Minuto en mayusculas._

---

### 2.3. Errores comunes

Verifica como tienes ordenados tus datos.<br>
- Verifica si usas **/** o **-** para separar tus fechas, o que otro separador puede existir en tus datos.

Para el formato '21-12-2017 05:30:01'.
```{r, eval=FALSE}
#format = "%d-%m-%Y %H:%M:%S"
```

Para el formato '2017/12/21 05:30:01'.
```{r, eval=FALSE}
#format = "%Y/%m/%d %H:%M:%S"
```

---

### 2.4. Verificar datos.

Verifica que tus datos no tengan NAs ni ceros en día y hora.
```{r}
range(Todos_GPS$DiaHora)
```

Si tienes **NAs**, deberas sacarlos.
```{r}
Todos_GPS_Limpio<-Todos_GPS%>%
  drop_na(DiaHora)
```

Si tienes ceros, puedes usar **filter** y **!=** que significa **diferente de**.
```{r}
Todos_GPS_Limpio<-Todos_GPS%>%
  filter(DiaHora != 0)
```

---

class: center, middle

<h1>`r fa("clock", fill = "#2a9d8f")`
## 3. Corregir la hora
Para esta parte puedes necesitar algunos básicos de como manipular data frames en R, si necesitas más información [ve aquí](https://miriamll.github.io/Curso_CIAD/Clase3Parte2#1).

---

### 3.1. Usando mutate

Cargar la libreria.
```{r, message=FALSE}
library(tidyverse)
```

Renombra el objeto.
```{r}
Opcion1<-Todos_GPS
```

Supongamos que para nuestros datos tenemos 5 horas de diferencia.  

Para restar las 5 horas, creamos una columna que se llama HoraReal, no es necesario pero sirve para verificar que todo este correcto.
```{r}
Opcion1<-Opcion1 %>%
  mutate(HoraReal = DiaHora - 5*60*60)
```
Nota que hora se resta a la columna DiaHora y las cinco horas se multiplican por los minutos y segundos.

---

### 3.1. Usando mutate

Listo!
```{r}
head(Opcion1$HoraReal,5)
```

Verificar
```{r}
range(Opcion1$HoraReal)
```

---

### 3.2. Usando dmy_hms

Cargar libreria.
```{r, message=FALSE}
library(lubridate)
```

Renombra tu objeto.
```{r}
Opcion2<-Todos_GPS
```

Convertir usando dmy_hms
```{r}
Opcion2$DiaHora<-paste(Opcion2$DateGMT,Opcion2$TimeGMT)
Opcion2$DiaHora<-dmy_hms(Opcion2$DiaHora)
```

Restar los segundos de diferencia
```{r}
Opcion2$HoraReal <- Opcion2$DiaHora - 3600*5
```
Nota que hora se resta a la columna DiaHora y las cinco horas se multiplican por los minutos y segundos.

---

### 3.2. Usando dmy_hms

Listo!
```{r}
head(Opcion2$HoraReal,5)
```

Verificar
```{r}
range(Opcion2$HoraReal)
```

---

### 3.3. Usando lubridate

Renombra tu objeto
```{r}
Opcion3<-Todos_GPS
```

Cargar paquete
```{r, message=FALSE}
library(lubridate)
```

El formato original es probablemente tz Europe/Amsterdam
```{r}
Opcion3$Hora<-ymd_hms(Opcion3$DiaHora, tz = "Europe/Amsterdam")
```

```{r}
head(Opcion3$Hora)
```

---

### 3.4. Usando lubridate

Para cambiarlo usar **with_tz**.
```{r}
Opcion3$HoraReal <- with_tz(Opcion3$Hora,tzone = "America/La_Paz")
```


Listo!
```{r}
head(Opcion3$HoraReal,5)
```

Verificar
```{r}
range(Opcion3$HoraReal)
```

---

### 3.4. Usando with_tz

Para elegir la tzone tienes que conocer el **nombre de tu región** y considera el **horario de verano**.

Para ver en R la lista de nombres de las zonas horarias aceptadas usa la siguiente linea de código.
```{r, eval=FALSE}
OlsonNames()
```
Te van a aparecer muchos resultados.

Otra opción es ver la [lista en Wikipedia](https://en.wikipedia.org/wiki/List_of_tz_database_time_zones).



---

class: center, middle

<h1>`r fa("file-export", fill = "#2a9d8f")`

# 4. Exportar 
Para esta parte necesitas saber cargar tus datos, si necesitas recordar como hacerlo, te recomiendo [empezar por aquí](https://miriamll.github.io/Curso_CIAD/Clase3Parte2#54).

---

### 4.1. Exportar 

Seleccionar la carpeta.
```{r}
library(here)
DatosFolder<-here::here("01Datos")
```

Seleccionar archivo
```{r}
GPS_Todos<-Opcion1
GPS_Todos<-Opcion2
GPS_Todos<-Opcion3
```

Exportar el nuevo data frame. 
```{r, eval=FALSE}
write_csv(
  Todos_GPS,
  file=paste0(DatosFolder,'/Todos_GPS.csv'))
```


---

## 5. Contacto

Para dudas, comentarios y sugerencias:  
- Escríbeme a miriamjlerma@gmail.com

Este material esta accesible y se encuentra en 
- mi [github](https://github.com/MiriamLL/Curso_tracking/).

<br>

Si quieres dar créditos puedes usar:
- Lerma M, 2021. Clase biologging. Próximamente con zenodo. 
- Lerma M, Dehnhard N, Luna-Jorquera G, Voigt CC, Garthe SS (2020) Breeding stage, not sex, affects foraging characteristics in masked boobies at Rapa Nui. Behavioral ecology and sociobiology 74: 149 [OpenAccess](https://link.springer.com/article/10.1007/s00265-020-02921-1)
Los datos de prueba vienen de esa publicación. 

<br>
<br>
<br>
<br>

.center[
```{r, echo=FALSE}
library(fontawesome)
```
<h3>`r fa("home", fill = "#2a9d8f")`[Volver ](https://miriamlerma.netlify.app/posts/2021-03-16-biologging/)
]
